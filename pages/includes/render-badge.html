<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Badge Details</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>

<div class="row">
    <div class="col-lg-9 badgeProfile"></div>
    <div class="col-lg-3 badgeOptions"></div>
</div>

<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <i class="fa fa-tags fa-2x"></i> Badge Assertions
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="table-responsive">
                            <table
                                class="table table-striped"
                                id="table"
                                data-sort-name="priority"
                                data-sort-order="desc"
                                data-toolbar="#toolbar"
                                data-search="true"
                                data-show-refresh="true"
                                data-show-toggle="true"
                                data-show-columns="true"
                                data-show-export="true"
                                data-minimum-count-columns="1"
                                data-id-field="id"
                                data-show-footer="false">
                            </table>
                        </div>
                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.col-lg-4 (nested) -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->

    </div>
    <!-- /.col-lg-8 -->
</div>
<!-- /.row -->

<script>

    $('#table').data('url', "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/badgeAssertions/" + badge.badgeId);

    var $table = $('#table'),
        $remove = $('#remove'),
        selections = [];

    function initTable() {
        $table.bootstrapTable({
            columns: [
                    {
                        field: 'recipient',
                        title: 'User',
                        valign: 'middle',
                        sortable: true,
                        align: 'middle',
                        formatter: recipientFormatter
                    }, {
                        field: 'acquired',
                        title: 'Acquired',
                        valign: 'middle',
                        sortable: true,
                        align: 'center',
                        formatter: dateFormatter
                    }, {
                        field: 'status',
                        title: 'Status',
                        valign: 'middle',
                        sortable: true,
                        align: 'center',
                    }
            ]
        });

        setTimeout(function () {
            $table.bootstrapTable('resetView');;
        }, 200);

        $table.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table',
            function () {
                $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);

                // save your data, here just save the current page
                selections = getIdSelections();
                // push or splice the selections if you want to save all data selections
            });

        $table.on('expand-row.bs.table', function (e, index, row, $detail) {
            console.log(index, row);
        });

        $table.on('all.bs.table', function (e, name, args) {
            console.log(name, args);
        });

        $table.on('editable-save.bs.table', function (e, field, row, old, $el) {

            json_data = JSON.stringify({
                "badgeId": row['badgeId'],
                "key": field,
                "value": row[field]
            })
            console.log(json_data);
            var request = $.ajax({
                url: "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/badges/" + row['badgeId'],
                type: "PATCH",
                contentType: 'application/json',
                dataType: "json",
                data: json_data,
                processData: false,
                success: function (data) {
                    onSuccess("Updated: " + json_data);
                },
                error: function (data) {
                    var error = data.status + " (" + data.statusText + "): " + data.responseText;
                    onDanger("Failed: " + error);
                }
            })
        });


        $remove.click(function () {
            var badgeIds = getIdSelections();
            $table.bootstrapTable('remove', {
                field: 'badgeId',
                values: badgeIds
            });
            $remove.prop('disabled', true);
        });
        $(window).resize(function () {
            $table.bootstrapTable('resetView', {
                height: getHeight()
            });
        });
    }

    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.badgeId
        });
    }

    function responseHandler(res) {
        $.each(res.rows, function (i, row) {
            row.state = $.inArray(row.id, selections) !== -1;
        });
        return res;
    }

    function recipientFormatter(value, row, index){
        html = '<a class="recipient">' + value + '</a>'
        return html;
    };

    function detailFormatter(index, row) {
        var html = [];
        $.each(row, function (key, value) {
            html.push('<p><b>' + key + ':</b> ' + value + '</p>');
        });
        return html.join('');
    }

    function imageFormatter(value, row, index) {
        console.log(row.badgeId)
        return [
            '<img ',
                'src="../images/badges/64/' + row.badgeId + '.png" ',
                'class="backup_picture_64 clickable_badge" onerror="imgError(this, 64);"',
                'alt=' + row.badgeId,
            '>'
        ].join('');
    }

    function dateFormatter(value, row, index){
        //return value
        return parseDateAsLocal(value)
    }

//Begin Click Functions
        function operateFormatter(value, row, index) {
            //We can add api call to add/remove/greyout buttons depending on how the user has indicated in the past
            var html = [];
            if (row.selfAssign) {
                html.push (
                    '<a class="add" href="javascript:void(0)" title="Add">',
                    '<i class="glyphicon glyphicon-plus"></i>',
                    '</a>')
                };
            html.push (
                '<a class="interest" href="javascript:void(0)" title="Interested">',
                '<i class="glyphicon glyphicon-heart" style="color:red"></i>',
                '</a>',
                '<a class="inProgress" href="javascript:void(0)" title="In Progress">',
                '<i class="glyphicon glyphicon-star" style="color:orange"></i>',
                '</a>')
            return html.join('');
        }

        //TODO: What operateEvents do we need for personal badges
        window.operateEvents = {
            'click .like': function (e, value, row, index) {

            },
            'click .remove': function (e, value, row, index) {

            },
            'click .add': function (e, value, row, index) {
                badgeid = row.badgeId;
                recipient = loggedInUserId;
                csv = parseCSVtoArray("badgeId,recipient\n" + badgeid + "," + recipient);
                console.log(csv);
                addDataToTable("userAssertions", csv);
            }
        };
//End Click Functions

    //On image error put placeholder
    window.imageEvents = {
        'error .backup_picture_64': function (e, value, row, index) {
            $(this).attr('src', '../images/badges/64/placeholder_badge.png');
        }
    };

    initTable();
    //renderUserOverview();

    renderBadge();







    function renderBadge(){
        var request = $.ajax({
            dataType: "json",
            url: "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/badgeAssertions/" + badge.badgeId,
            success: function (data) {
                console.log(data)
                renderBadgeProfile();
                renderBadgeOptions();
            }
        });
    }

    function renderBadgeProfile(){
        var html = [];
        html.push(`
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <i class="fa fa-user fa-2x"></i> `+badge.description+`
                    </div>

                    <div class="panel-body">
                        <img src="../images/badges/256/`+badge.badgeId+`.png" onerror="imgError(this, 256)" class="img-responsive backup_picture_256 center-block clickable_badge" alt="`+badge.badgeId+`">
                    </div>
                </div>
        `)
        $(".badgeProfile").append(html);
    };



    function renderBadgeOptions(){
        var html = [];
        html.push(`
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <i class="fa fa-tag fa-2x"></i> Badge Options
                    </div>

                    <div class="panel-body">
                        <p>
                            <button type="button" class="btn btn-primary btn-md btn-block">Button 1</button>
                            <button id="renderEmailButton" type="button" class="btn btn-primary btn-md btn-block">Button 2</button>
                        </p>
                    </div>
                </div>
        `)
        $(".badgeOptions").append(html);
    };

    function renderBadgesObtained(badges){
        console.log(badges);
        var html = [];
        var obtainedBadges = [];
        for (var i = 0; i < badges.length; i++) {
            if (badges[i].status == 'Obtained') {
                obtainedBadges.push(`
                    <img src="../images/badges/64/`+badges[i].badgeId+`.png"
                    class="clickable_badge img-responsive" style="display:inline-block"; onerror="imgError(this, 64)" alt="` + badges[i].badgeId + `">`
                )
            }
        }
        html.push(`
                <div class="panel panel-success">
                    <div class="panel-heading">
                        <i class="fa fa-user fa-2x"></i> Obtained
                    </div>

                    <div class="panel-body">
                        `+obtainedBadges+`
                    </div>
                </div>
        `)
        $(".badgesObtained").append(html);
    };



    function renderBadgesInProgress(badges){
      console.log(badges);
        var html = [];
        var obtainedBadges = [];
        for (var i = 0; i < badges.length; i++) {
            if (badges[i].status == 'Obtained') {
                obtainedBadges.push(`
                    <img src="../images/badges/64/` + badges[i].badgeId + `.png"
                    class="clickable_badge img-responsive" style="display:inline-block"; onerror="imgError(this, 64)" alt="` + badges[i].badgeId + `">`
                )
            }
        }
        html.push(`
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <i class="fa fa-user fa-2x"></i> In Progress
                    </div>

                    <div class="panel-body">
                        `+obtainedBadges+`
                    </div>
                </div>
        `)
        $(".badgesInProgess").append(html);
    };


    function renderBadgesInterest(badges){
        var html = [];
        var obtainedBadges = [];
        for (var i = 0; i < badges.length; i++) {
            if (badges[i].status == 'Obtained') {
                obtainedBadges.push(`
                    <img src="../images/badges/64/` + badges[i].badgeId + `.png"
                    class="clickable_badge img-responsive" style="display:inline-block"; onerror="imgError(this, 64)" alt="` + badges[i].badgeId + `">`
                )
            }
        }
        html.push(`
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        <i class="fa fa-user fa-2x"></i> Interest
                    </div>

                    <div class="panel-body">
                        `+obtainedBadges+`
                    </div>

                </div>
        `)
        $(".badgesInterest").append(html);
    };



</script>