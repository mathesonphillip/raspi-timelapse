<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Company Overview</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>

<div class="row overview">
    
</div>


<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <i class="fa fa-tags fa-2x"></i> CSC Priority Badges
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="table-responsive">
                            <table 
                                class="table table-striped" 
                                id="table" 
                                data-sort-name="priority" 
                                data-sort-order="desc" 
                                data-toolbar="#toolbar" 
                                data-search="true" 
                                data-show-refresh="true" 
                                data-show-toggle="true" 
                                data-show-columns="true" 
                                data-show-export="true" 
                                data-minimum-count-columns="1" 
                                data-id-field="id" 
                                data-show-footer="false" 
                                data-url="https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/testingpath/focus">
                            </table>
                        </div>
                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.col-lg-4 (nested) -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->

    </div>
    <!-- /.col-lg-8 -->

</div>
<!-- /.row -->

<script type="text/javascript">

$(document).ready(function () {
    getFocusBadges();
    populateTable();
} );  

function populateTable(){

}

function getFocusBadges(){
    var result
    $.ajax({
        url: "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/testingpath/focus/",
        success: function (data) {
            console.log('getFocusBadges success');
            data = sortPriority(data);           
            renderPriorityBadges(data)
        },
        error: function (data) {
            console.log('getFocusBadges error');
        }
    });
}

function sortPriority(data){
    data.sort(function (a, b) {
                        var keyA = a.priority,
                            keyB = b.priority;
                        // Compare the 2 dates
                        if (keyA > keyB) return -1;
                        if (keyA < keyB) return 1;
                    });
    console.log(data)
    return data
    }

function renderPriorityBadges(focusBadges){
    badgesToRender = 4
    var html = []
    
    console.log(focusBadges)
    
    for (var i = 0; i < badgesToRender; i++) {
        console.log(focusBadges[i].badgeId)

        //Calculate numbers for progress bars
        var valueTarget = (((focusBadges[i].issueCount / focusBadges[i].issueTarget) * 100 > 100) ? 100 : focusBadges[i].issueCount / focusBadges[i].issueTarget * 100);
        //Set color of bar by adding class
        switch (true) {
        case (valueTarget < 25):
            badgeClass = "progress-bar-danger";
            break
        case (valueTarget >= 25 && valueTarget <= 50):
            break
            badgeClass = "progress-bar-warning";
        case (valueTarget >= 50 && valueTarget <= 75):
            break
            $badgeClass = "progress-bar-info";
        case (valueTarget > 75):
            badgeClass = "progress-bar-success";
            break;
        }
        console.log(valueTarget)

        html.push(`
            <div class="col-lg-3">
                <div class="panel panel-primary">

                    <div class="panel-heading">
                        <i class="fa fa-tag fa-1x"></i>
                        ` + focusBadges[i].badgeId.substring(0, 10) + `
                    </div>

                    <div class="panel-body">
                        <img src="../images/badges/128/` + focusBadges[i].badgeId + `.png" class="img-responsive backup_picture_256 clickable_badge center-block" alt="">
                    </div>

                        <div class="panel-footer">
                                <div class="progress">
                                    <div class="progress-bar `+badgeClass+`" role="progressbar" aria-valuenow="`+valueTarget+`" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: `+valueTarget+`%">
                                        <span>`+Math.round(focusBadges[i].issueCount / focusBadges[i].issueTarget * 100) + "%"+`</span>
                                    </div>
                                </div>
                                <span class="text-center center-block">`+focusBadges[i].issueCount+"/" + focusBadges[i].issueTarget+`</span>
                        </div>
                </div>
            </div>`
        )
    }
        $(".overview").append(html);
}


</script>


<script>
    var $table = $('#table'),
        $remove = $('#remove'),
        selections = [];

    function initTable() {
        $table.bootstrapTable({
            columns: [
                {
                    field: 'img',
                    title: 'Image',
                    sortable: false,
                    align: 'center',
                    valign: 'middle',
                    events: imageEvents,
                    formatter: imageFormatter
                    }, {
                    field: 'description',
                    title: 'Badge Description',
                    valign: 'middle',
                    sortable: true,
                    align: 'left'
                    }, {
                    field: 'issueCount',
                    title: 'Issued',
                    valign: 'middle',
                    sortable: true,
                    align: 'center'
                    }, {
                    field: 'lastAcquired',
                    title: 'Last Acquired',
                    valign: 'middle',
                    sortable: true,
                    align: 'center',
                    formatter: dateFormatter
                    }, {
                    field: 'priority',
                    title: 'Priority',
                    valign: 'middle',
                    sortable: true,
                    align: 'center'
                    }, {
                    field: 'issueTarget',
                    title: 'Badge Target',
                    valign: 'middle',
                    sortable: true,
                    align: 'center'
                    },
                {
                        field: 'operate',
                        title: 'Operate',
                        valign: 'middle',
                        align: 'center',
                        events: operateEvents,
                        formatter: operateFormatter
                    }

            ]
        });

        setTimeout(function () {
            $table.bootstrapTable('resetView');;
        }, 200);

        $table.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table',
            function () {
                $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);

                // save your data, here just save the current page
                selections = getIdSelections();
                // push or splice the selections if you want to save all data selections
            });

        $table.on('expand-row.bs.table', function (e, index, row, $detail) {
            console.log(index, row);
        });

        $table.on('all.bs.table', function (e, name, args) {
            console.log(name, args);
        });

        $table.on('editable-save.bs.table', function (e, field, row, old, $el) {

            json_data = JSON.stringify({
                "badgeId": row['badgeId'],
                "key": field,
                "value": row[field]
            })
            console.log(json_data);
            var request = $.ajax({
                url: "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/badges/" + row['badgeId'],
                type: "PATCH",
                contentType: 'application/json',
                dataType: "json",
                data: json_data,
                processData: false,
                success: function (data) {
                    onSuccess("Updated: " + json_data);
                },
                error: function (data) {
                    var error = data.status + " (" + data.statusText + "): " + data.responseText;
                    onDanger("Failed: " + error);
                }
            })
        });


        $remove.click(function () {
            var badgeIds = getIdSelections();
            $table.bootstrapTable('remove', {
                field: 'badgeId',
                values: badgeIds
            });
            $remove.prop('disabled', true);
        });
        $(window).resize(function () {
            $table.bootstrapTable('resetView', {
                height: getHeight()
            });
        });
    }

    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.badgeId
        });
    }

    function responseHandler(res) {
        $.each(res.rows, function (i, row) {
            row.state = $.inArray(row.id, selections) !== -1;
        });
        return res;
    }

    function detailFormatter(index, row) {
        var html = [];
        $.each(row, function (key, value) {
            html.push('<p><b>' + key + ':</b> ' + value + '</p>');
        });
        return html.join('');
    }

    function imageFormatter(value, row, index) {
        console.log(row.badgeId)
        return [
            '<img ',
                'src="../images/badges/64/' + row.badgeId + '.png" ',
                'class="backup_picture_64 clickable_badge" onerror="imgError(this, 64);"',
                'alt=' + row.badgeId,
            '>'
        ].join('');
    }

    function dateFormatter(value, row, index){
        return value
        //return parseDateAsLocal(value)
    }

//Begin Click Functions
        function operateFormatter(value, row, index) {
            //We can add api call to add/remove/greyout buttons depending on how the user has indicated in the past
            var html = [];
            if (row.selfAssign) {
                html.push (
                    '<a class="add" href="javascript:void(0)" title="Add">',
                    '<i class="glyphicon glyphicon-plus"></i>',
                    '</a>')
                };
            html.push (
                '<a class="interest" href="javascript:void(0)" title="Interested">',
                '<i class="glyphicon glyphicon-heart" style="color:red"></i>',
                '</a>',
                '<a class="inProgress" href="javascript:void(0)" title="In Progress">',
                '<i class="glyphicon glyphicon-star" style="color:orange"></i>',
                '</a>')
            return html.join('');
        }

        //TODO: What operateEvents do we need for personal badges
        window.operateEvents = {
            'click .like': function (e, value, row, index) {

            },
            'click .remove': function (e, value, row, index) {

            },
            'click .add': function (e, value, row, index) {
                badgeid = row.badgeId;
                recipient = loggedInUserId;
                csv = parseCSVtoArray("badgeId,recipient\n" + badgeid + "," + recipient);
                console.log(csv);
                addDataToTable("userAssertions", csv);
            }
        };
//End Click Functions

    //On image error put placeholder
    window.imageEvents = {
        'error .backup_picture_64': function (e, value, row, index) {
            $(this).attr('src', './images/badges/64/placeholder_badge.png');
        }
    };

    initTable();

</script>