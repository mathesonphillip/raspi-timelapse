<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Badges</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>

<!-- <div class="userOverview"></div> -->

<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <i class="fa fa-tags fa-2x"></i> Badges
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="table-responsive">
                            <table
                                class="table table-striped"
                                id="table"
                                data-sort-name="issueCount"
                                data-sort-order="desc"
                                data-toolbar="#toolbar"
                                data-search="true"
                                data-show-refresh="true"
                                data-show-toggle="true"
                                data-show-columns="true"
                                data-show-export="true"
                                data-minimum-count-columns="1"
                                data-id-field="id"
                                data-show-footer="false">
                            </table>
                        </div>
                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.col-lg-4 (nested) -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->

    </div>
    <!-- /.col-lg-8 -->

</div>
<!-- /.row -->

<script>

    $('#table').data('url', "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/badges/");

    var $table = $('#table'),
        $remove = $('#remove'),
        selections = [];

    function initTable() {
        $table.bootstrapTable({
            columns: [
                {
                    field: 'img',
                    title: 'Image',
                    sortable: false,
                    editable: false,
                    align: 'center',
                    valign: 'middle',
                    events: imageEvents,
                    formatter: imageFormatter
                    },
                    {
                    field: 'description',
                    title: 'Badge Description',
                    valign: 'middle',
                    sortable: true,
                    align: 'left'
                    }, {
                    field: 'category',
                    title: 'Category',
                    valign: 'middle',
                    sortable: true,
                    align: 'center'
                    }, {
                    field: 'issueCount',
                    title: 'Issued',
                    valign: 'middle',
                    sortable: true,
                    align: 'center'
                    }, {
                    field: 'lastAcquired',
                    title: 'Last Acquired',
                    valign: 'middle',
                    sortable: true,
                    align: 'center',
                    formatter: dateFormatter
                    }, {
                    field: 'priority',
                    title: 'Priority',
                    valign: 'middle',
                    sortable: true,
                    align: 'center'
                    }, {
                    field: 'issueTarget',
                    title: 'Badge Target',
                    valign: 'middle',
                    sortable: true,
                    align: 'center'
                    }, {
                    field: 'operate',
                    title: 'Item Operate',
                    valign: 'middle',
                    align: 'center',
                    formatter: operateFormatter
                    }

            ]
        });

        setTimeout(function () {
            $table.bootstrapTable('resetView');;
        }, 200);

        $table.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table',
            function () {
                $remove.prop('disabled', !$table.bootstrapTable('getSelections').length);

                // save your data, here just save the current page
                selections = getIdSelections();
                // push or splice the selections if you want to save all data selections
            });

        $table.on('expand-row.bs.table', function (e, index, row, $detail) {
            console.log(index, row);
        });

        $table.on('all.bs.table', function (e, name, args) {
            console.log(name, args);
        });

        $table.on('editable-save.bs.table', function (e, field, row, old, $el) {

            json_data = JSON.stringify({
                "badgeId": row['badgeId'],
                "key": field,
                "value": row[field]
            })
            var request = $.ajax({
                url: "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/badges/" + row['badgeId'],
                type: "PATCH",
                contentType: 'application/json',
                dataType: "json",
                data: json_data,
                processData: false,
                success: function (data) {
                    onSuccess("Updated: " + json_data);
                },
                error: function (data) {
                    var error = data.status + " (" + data.statusText + "): " + data.responseText;
                    onDanger("Failed: " + error);
                }
            })
        });


        $remove.click(function () {
            var badgeIds = getIdSelections();
            $table.bootstrapTable('remove', {
                field: 'badgeId',
                values: badgeIds
            });
            $remove.prop('disabled', true);
        });
        $(window).resize(function () {
            $table.bootstrapTable('resetView', {
                height: getHeight()
            });
        });
    }

    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.badgeId
        });
    }

    function responseHandler(res) {
        $.each(res.rows, function (i, row) {
            row.state = $.inArray(row.id, selections) !== -1;
        });
        return res;
    }

    function detailFormatter(index, row) {
        var html = [];
        $.each(row, function (key, value) {
            html.push('<p><b>' + key + ':</b> ' + value + '</p>');
        });
        return html.join('');
    }

    function imageFormatter(value, row, index) {
        return [
            '<img ',
                'src="../images/badges/64/' + row.badgeId + '.png" ',
                'class="backup_picture_64 clickable_badge" onerror="imgError(this, 64);"',
                'alt=' + row.badgeId,
            '>'
        ].join('');
    }

    function dateFormatter(value, row, index){
        return value
        //return parseDateAsLocal(value)
    }


        function operateFormatter(value, row, index) {
            //We can add api call to add/remove/greyout buttons depending on how the user has indicated in the past
            var html = [];
            if (row.selfAssign) {
                html.push (`
                    <a class="addBadgeButton" href="javascript:void(0)" data-badgeId="`+row.badgeId+`" title="Add">,
                    <i class="glyphicon glyphicon-plus"></i>
                    </a>'
                `)
            };
            html.push (`
                <a class="interestBadgeButton" href="javascript:void(0)" data-badgeId="`+row.badgeId+`" title="Interested">
                <i class="glyphicon glyphicon-heart" style="color:red"></i>
                </a>
                <a class="inProgressBadgeButton" href="javascript:void(0)" data-badgeId="`+row.badgeId+`" title="In Progress">
                <i class="glyphicon glyphicon-star" style="color:orange"></i>
                </a>
            `)
            return html.join('');
        }

    //On image error put placeholder
    window.imageEvents = {
        'error .backup_picture_64': function (e, value, row, index) {
            $(this).attr('src', '../images/badges/64/placeholder_badge.png');
        }
    };

    initTable();
    //renderUserOverview();
    //renderUserBadgeSummary();

    function renderUserBadgeSummary(){

    data = $.ajax({
        dataType: "json",
        url: "https://x0cqlc5za2.execute-api.ap-southeast-2.amazonaws.com/dev/userAssertions/" + loggedInUserId,
        success: function(data){
            badgeSummary(data);
        }
    });
}

function badgeSummary(data) {
    var html = [];
    for (var i = data.length - 1; i >= 0; i--) {
        html.push(`
            <img src="../images/badges/128/` + data[i].badgeId + `.png"
            class="clickable_badge" onerror="imgError(this, 128);" alt="` + data[i].badgeId + `">`
        )
    }
    renderUserOverview(html)
}

</script>